{% extends 'base.html' %}

{% load crispy_forms_tags %}

{% load static %}

{% block title %}
    Weekly Status
{% endblock title %}

{% block content %}

    <div class="row justify-content-lg-center">
        <div class="row col-lg-4">

            <button type="button" class="btn btn-primary" onclick="showDiv()">
                Add Weekly Status
            </button>
        </div>
        <br/>

        <div id="TestsDiv" class="row justify-content-lg-center">
            <div class="d-flex justify-content-center">
                <div class="card" style="width: 25%;" id="content">
                    <div class="card-header text-white bg-primary mb-3">
                        Add status
                    </div>
                    <div class="card-body">
                        <form action="" method="POST">
                            <div class="form-group">
                                {% csrf_token %}
                                <label for="{{ form.theuserIssues.auto_id }}">
                                    Github Issues
                                    for {{ user.first_name | capfirst }}
                                </label>
                                {{ form|crispy }}
                            </div>
                            <input class="btn btn-primary" type="submit"
                                   value="Submit">
                        </form>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <br/>
{% if user.is_superuser %}
    <div class="row justify-content-lg-center">
        <div class="row col-lg-4">

            <button id='createDoc' type="button" class="btn btn-primary"
                    onclick="">
                Generate Weekly Status
            </button>
        </div>
    </div>
    <br/>

    <br/>

     <div class="row">
        <div class="col-8 offset-2">
            <table id="weekly-status-table"
                   class="table table-striped table-hover custom-table-dark custom-table-bordered">
                <thead>
                <tr>
                    <th>Week Ending</th>
                    <th>User Status</th>
                    <th>Key Accomplishments</th>
                    <th>Ongoing Task</th>
                    <th>Upcoming Task</th>
                    <th>Obstacles</th>
                    <th>Non-standard Meeting</th>
                    <th>Deliverables</th>
                    <th>PTO</th>
                    <th>Notes</th>
                    <th>Status Complete</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
{% endif %}
    <br/>


    <script>
        function showDiv() {
            let T = document.getElementById("TestsDiv"),
                displayValue = "";
            if (T.style.display == "") displayValue = "none";
            T.style.display = displayValue;
        }

        function fetchWeeklyStatuses() {
            $.ajax({
                url: '{% url "fetch_weekly_statuses" %}',
                type: 'GET',
                success: function (data) {

                    let tableBody = $('#weekly-status-table tbody');
                    tableBody.empty();
                    data.forEach(function (status) {
                        let row = $('<tr>');
                        row.append($('<td>').text(status.week_ending));
                        row.append($('<td>').text(status.user_status));
                        row.append($('<td>').text(status.key_accomplishments));
                        row.append($('<td>').text(status.ongoing_task));
                        row.append($('<td>').text(status.upcoming_task));
                        row.append($('<td>').text(status.obstacles));
                        row.append($('<td>').text(status.non_standard_meeting));
                        row.append($('<td>').text(status.deliverables));
                        row.append($('<td>').text(status.pto));
                        row.append($('<td>').text(status.notes));
                        row.append($('<td>').text(status.statusComplete));
                        tableBody.append(row);
                    });
                },
                error: function (xhr, errmsg, err) {
                    console.log("Error: " + errmsg);
                }
            });
        }

        function loading() {
            $("#loading").show();
            $("#content").hide();
        }

        $(document).ready(function () {
            console.log("Im ready ");

            fetchWeeklyStatuses();
            setInterval(fetchWeeklyStatuses, 10000);

            $('#createDoc').click(function () {
                $.ajax({
                    url: '{% url "create_word_doc" %}',
                    type: 'GET',
                    xhrFields: {
                        responseType: 'blob'
                    },
                    success: function (blob) {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'My_Word_Document.docx';
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                    },
                    error: function (xhr, errmsg, err) {
                        console.log("Error: " + errmsg);
                    }
                });
            });


            showDiv();

            setTimeout(function () {
                $("#messageDiv").fadeOut("fast");
            }, 5000);
            $(window).load(function () {
                $("#loading").hide();
            });


        });
    </script>

    
{% endblock %}
